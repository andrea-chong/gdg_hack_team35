<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ING Voice â€” Live Assistant</title>
  <style>
    body { font-family: ui-sans-serif, system-ui; max-width: 720px; margin: 40px auto; }
    h1 { margin-bottom: 8px; }
    .row { margin: 12px 0; }
    button { font-size: 18px; padding: 12px 18px; border-radius: 10px; cursor: pointer; }
    #status { font-size: 14px; opacity: 0.8; }
    textarea { width: 100%; height: 80px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>ING Voice â€” Live Assistant</h1>
  <div class="row">
    <label>Language</label><br/>
    <select id="lang">
      <option value="en-GB">English (GB)</option>
      <option value="nl-BE">Dutch (BE)</option>
      <option value="fr-BE">French (BE)</option>
    </select>
  </div>
  <div class="row">
    <button id="ptt">ðŸŽ¤ Hold to talk</button>
    <span id="status"></span>
  </div>
  <div class="row">
    <label>Assistant reply (text)</label><br/>
    <textarea id="reply" readonly></textarea>
  </div>
  <audio id="player" controls></audio>

<script>
const API = "https://ing-voice-307966155885.europe-west1.run.app";

let mediaRecorder, chunks=[];
const ptt = document.getElementById("ptt");
const statusEl = document.getElementById("status");
const player = document.getElementById("player");
const replyBox = document.getElementById("reply");

async function getStream() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  return stream;
}

ptt.onmousedown = async () => {
  statusEl.textContent = "Recording...";
  chunks = [];
  const stream = await getStream();
  mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
  mediaRecorder.onstop = onStop;
  mediaRecorder.start();
};

ptt.onmouseup = () => {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    statusEl.textContent = "Processing...";
    mediaRecorder.stop();
  }
};

async function onStop() {
  // Convert Blob -> ArrayBuffer -> base64
  const blob = new Blob(chunks, { type: "audio/webm" });
  const arrayBuf = await blob.arrayBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuf)));
  const lang = document.getElementById("lang").value;

  // Send to /assist
  try {
    const res = await fetch(`${API}/assist`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ audio: base64, lang })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    replyBox.value = data.text || "";
    player.src = "data:audio/mpeg;base64," + data.audio;
    await player.play();
    statusEl.textContent = "Done. Hold to talk again.";
  } catch (e) {
    statusEl.textContent = "Error: " + e.message;
  }
}
</script>
</body>
</html>
